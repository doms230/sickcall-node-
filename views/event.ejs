<!DOCTYPE html>
<html lang ="en">
<head>
    <title> <%= title %> | Hiikey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <!-- Parse SDK -->
    <script src="//www.parsecdn.com/js/parse-1.6.14.min.js"></script>

    <!-- Stripe SDK   <script type="text/javascript" src="https://js.stripe.com/v2/"></script>  -->

    <!-- <script type="text/javascript" src="https://js.stripe.com/v2/"></script> -->
    <script src="https://checkout.stripe.com/checkout.js"></script>

    <!--Ajax -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

</head>
<body>

<nav class="navbar navbar-default ">
    <div class="container-fluid">
        <div class="navbar-header">
            <p class="navbar-text"><%=user%></p>
            <a  id="log" href="/login/auth/facebook" class="btn btn-primary navbar-btn"><span class="fa fa-twitter"></span><%=logButton%></a>
        </div>
    </div>
</nav>

<div class="page-header">
    <h1><%= title %><small> <%= date %></small></h1>
    <h6><%= description %></h6>
</div>

<div class="col-md-8">
    <img src=<%= image %> class="img-thumbnail" alt="Responsive image">
</div>

<div class="container-fluid">
    <div class="row">
        <div class= "col-md-4">
            <h4>Tickets</h4>

            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                </tr>
                </thead>

                <tbody>

                <% for(var i=0; i < data.length; i++) { %>
                <tr>
                    <td id= <%= data[i].nameId %>  ><%= data[i].name %></td>
                    <td id= <%= data[i].priceId %> ><%= data[i].price %> </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group" aria-label="...">
                            <input type="button" class= "btn btn-default disabled" id= <%= data[i].id %> value="0" />
                            <input type="Button" class="btn btn-danger" id= <%= data[i].minusButton %>  value="-"/>
                            <input type="Button" class="btn btn-success" id= <%= data[i].addButton %> value="+"/>
                        </div>
                    </td>
                </tr>
                <% } %>

                </tbody>
            </table>

            <a href="#" id= "pay" class="btn btn-default "><span class="fa fa-twitter"></span><%=status%></a>

            <script >

                var ticketQuantity;
                var ticketName;

                function changeQuantity(quan, addButton, minusButton) {
                    var counter = quan.val();

                    addButton.click(function () {
                        if (counter < 5) {
                            counter++;
                            quan.prop('value', counter);
                        }
                    });

                    minusButton.click(function () {
                        if (counter > 0) {
                            counter -= 1;
                            quan.prop('value', counter);
                        }
                    });
                }

//Access-Control-Allow-Origin: http://foo.example                }

                changeQuantity($('#0'),$('#addButton0'),$('#minusButton0'));
                changeQuantity($('#1'),$('#addButton1'),$('#minusButton1'));
                changeQuantity($('#2'),$('#addButton2'),$('#minusButton2'));

                // Define handler to be called when Stripe returns a card token
                function onReceiveToken(token, args) {


                    var getMerchant = $.get('/events/getMerchant', {
                    });

                    getMerchant.done(function(merchant){

                        var totalPrice = getTotal();
                        var appFee = (totalPrice * .029) + .30 ;

                        var buyTickets = $.post('/payments/buyTickets', {
                            stripeToken: token.id,
                            amount: totalPrice  * 100,
                            destination: merchant,
                            application_fee: Math.ceil(appFee * 100)
                        });

                        buyTickets.done(function(data){
                            var updateTickets = $.post('/events/updateTickets', {
                                ticketQuantity: ticketQuantity,
                                purchase: data.id
                            });

                            updateTickets.done(function(data){
                                //post jaunt to update database
                                //alert( data);
                                redirect("/profile");
                            });

                           // alert( "Data Loaded: " + data.id );
                        });
                    });
                }

                // Configure Checkout

                // Open Checkout when the link is clicked
                $('#pay').on('click', function() {

                    //ticketQuantity = [$('#0').val(), $('#1').val(), $('#2').val()];
                    ticketQuantity = [$('#0').val()];
                    var totalPrice = getTotal() ;

                    /*ticketQuantity = [$('#0').val(), $('#1').val(), $('#2').val()];
                    //ticketName = [$('#name0').text(), $('#name1').text(), $('#name2').text()];

                    totalPriceWithFees = totalPrice + (totalPrice * .029) + .30 ;

                    var checkout = StripeCheckout.configure({
                        key: 'pk_test_wMPl893ju7D1tv3DUO6CRCBh',
                        token: onReceiveToken,
                        amount: totalPriceWithFees * 100 ,
                        name: "Payment Information" ,
                        description: "Credit card processing fee: ",
                        zipCode: "true",
                        allowRememberMe: false,
                        locale: 'auto'
                    });

                    checkout.open();*/

                    if ($('#pay').text() == "Login before purchase"){
                        alert("Please Login before purchase.");

                    } else if (getQuantity() == 0){
                        alert("Please choose quantity before checkout.");

                    } else if(totalPrice == 0){

                        alert( "Good luck! If you won, we will contact you Thursday May 12th by email from hiikeyteam@gmail.com.");
                        var updateTickets = $.post('/events/updateTickets', {
                            ticketQuantity: ticketQuantity,
                            purchase: "free"
                        });

                        updateTickets.done(function(data){
                            //post jaunt to update database

                        });

                    } else {

                        //ticketName = [$('#name0').text(), $('#name1').text(), $('#name2').text()];

                        totalPriceWithFees = totalPrice + (totalPrice * .029) + .30 ;

                        var checkout = StripeCheckout.configure({
                            key: 'pk_test_wMPl893ju7D1tv3DUO6CRCBh',
                            token: onReceiveToken,
                            amount: totalPriceWithFees * 100 ,
                            name: "Payment Information" ,
                            description: "Credit card processing fee: ",
                            zipCode: "true",
                            allowRememberMe: false,
                            locale: 'auto'
                        });

                        checkout.open();
                    }

                    return false;
                });

                if ($('#log').text() == "Sign out") {
                    //alert('yo');
                    $('#log').attr("href", "/events/logout");
                }

                function getTotal() {
                    var subTotal = $('#0').val() * $('#price0').text();
                    //var subTotal1 = $('#1').val() * $('#price1').text();
                   // var subTotal2 = $('#2').val() * $('#price2').text();

                    //return subTotal + subTotal1 + subTotal2

                    return subTotal
                }

                function getQuantity(){
                    var quan = $('#0').val();
                   // var quan1 = $('#1').val();
                   // var quan2 = $('#2').val();

                    //return quan + quan1 + quan2
                    return quan
                }

                //put in label that shows the total before they decide to checkout

            </script>

        </div>
    </div>
</div>
</body>
</html>